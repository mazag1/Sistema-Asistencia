<div class="container mt-4">
    <h2><%= estudiante ? 'Editar Estudiante' : 'Agregar Estudiante' %></h2>
    
    <div id="mensaje" class="alert d-none"></div>

    <form id="formEstudiante" class="mt-3" enctype="multipart/form-data">
        <input type="hidden" id="id" name="id" value="<%= estudiante ? estudiante.id : '' %>">

        <div class="row">
            <div class="col-md-6">
                <label for="dni" class="form-label">DNI:</label>
                <input type="text" id="dni" name="dni" class="form-control" value="<%= estudiante ? estudiante.dni : '' %>" required>
            </div>
            <div class="col-md-6">
                <label for="nombre" class="form-label">Nombre:</label>
                <input type="text" id="nombre" name="nombre" class="form-control" value="<%= estudiante ? estudiante.nombre : '' %>" required>
            </div>
        </div>

        <div class="row mt-3">
            <div class="col-md-6">
                <label for="apellido_paterno" class="form-label">Apellido Paterno:</label>
                <input type="text" id="apellido_paterno" name="apellido_paterno" class="form-control" value="<%= estudiante ? estudiante.apellido_paterno : '' %>" required>
            </div>
            <div class="col-md-6">
                <label for="apellido_materno" class="form-label">Apellido Materno:</label>
                <input type="text" id="apellido_materno" name="apellido_materno" class="form-control" value="<%= estudiante ? estudiante.apellido_materno : '' %>" required>
            </div>
        </div>

        <div class="row mt-3">
            <div class="col-md-6">
                <label for="email" class="form-label">Correo Electrónico:</label>
                <input type="email" id="email" name="email" class="form-control" value="<%= estudiante ? estudiante.email : '' %>" required>
            </div>
            <div class="col-md-6">
                <label for="telefono" class="form-label">Teléfono:</label>
                <input type="text" id="telefono" name="telefono" class="form-control" value="<%= estudiante ? estudiante.telefono : '' %>" required>
            </div>
        </div>

        <div class="row mt-3">
            <div class="col-md-6">
                <label for="direccion" class="form-label">Dirección:</label>
                <input type="text" id="direccion" name="direccion" class="form-control" value="<%= estudiante ? estudiante.direccion : '' %>" required>
            </div>
            <div class="col-md-6">
                <label for="fecha_nacimiento" class="form-label">Fecha de Nacimiento:</label>
                <input type="date" id="fecha_nacimiento" name="fecha_nacimiento" class="form-control" value="<%= estudiante ? estudiante.fecha_nacimiento : '' %>" required>
            </div>
        </div>

        <div class="row mt-3">
            <div class="col-md-6">
                <label for="foto" class="form-label">Foto:</label>
                <input type="file" id="foto" name="foto" class="form-control">
                <% if (estudiante && estudiante.foto) { %>
                    <img src="/uploads/<%= estudiante.foto %>" alt="Foto del estudiante" class="mt-2 img-thumbnail" width="150">
                <% } %>
            </div>
        </div>

        <div class="row mt-3">
            <div class="col-md-6">
                <label for="grado" class="form-label">Grado:</label>
                <input type="text" id="grado" name="grado" class="form-control" value="<%= estudiante ? estudiante.grado : '' %>" required>
            </div>
            <div class="col-md-6">
                <label for="seccion" class="form-label">Sección:</label>
                <input type="text" id="seccion" name="seccion" class="form-control" value="<%= estudiante ? estudiante.seccion : '' %>" required>
            </div>
        </div>

        <div class="mt-4">
            <button type="submit" class="btn btn-primary">
                <%= estudiante ? 'Actualizar' : 'Guardar' %>
            </button>
            <a href="/estudiantes" class="btn btn-secondary">Cancelar</a>
        </div>
    </form>
</div>

<!-- Script para manejar la petición -->
<script>
    document.getElementById('formEstudiante').addEventListener('submit', async function(event) {
        event.preventDefault(); // Evita la recarga de la página

        const formData = new FormData(this); // Captura todos los datos del formulario, incluida la imagen

        const id = document.getElementById('id').value;
        const metodo = id ? 'PUT' : 'POST';
        const url = id ? `/api/estudiantes/${id}` : `/api/estudiantes`;

        try {
            const response = await fetch(url, {
                method: metodo,
                body: formData // Importante: enviar `formData` en lugar de JSON
            });

            const resultado = await response.json();
            if (!response.ok) throw new Error(resultado.message);

            mostrarMensaje(`Estudiante ${id ? 'actualizado' : 'registrado'} correctamente.`, 'success');

            setTimeout(() => {
                window.location.href = "/estudiantes"; // Redirige a la lista de estudiantes
            }, 1000);

        } catch (error) {
            mostrarMensaje(error.message, 'danger');
        }
    });
</script>

